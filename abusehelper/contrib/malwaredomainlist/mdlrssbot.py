"""
Malware Domainlist bot.

Maintainer: Lari Huttunen <mit-code@huttu.net>
"""
import re
import time
import socket
from abusehelper.core import bot, events
from abusehelper.contrib.rssbot import rssbot


class MalwareDomainListBot(rssbot.RSSBot):
    feeds = bot.ListParam(default=["http://www.malwaredomainlist.com/hostslist/mdl.xml"])

    def is_ip(self, string):
        for addr_type in (socket.AF_INET, socket.AF_INET6):
            try:
                socket.inet_pton(addr_type, string)
            except (ValueError, socket.error):
                pass
            else:
                return True
        return False

    def parse_date(self, date,
                in_format="%Y/%m/%d_%H:%M",
                out_format="%Y-%m-%d %H:%M:%SZ"):
        br = re.compile('[()]')
        timestr = br.sub('', date)
        try:
            struct = time.strptime(timestr, in_format)
        except ValueError:
            return
        return time.strftime(out_format, struct)

    def parse_title(self, title):
        port = re.compile(':')
        host, date = title.split()
        time = self.parse_date(date)
        if port.search(host):
            name, _ = host.split(':')
            return name, time
        else:
            return host, time

    def create_event(self, **keys):
        event = events.Event()
        # handle link
        link = keys.get("link", None)
        if link:
            event.add("description url", link)
        # handle title data
        title = keys.get("title")
        host, date = self.parse_title(title)
        if self.is_ip(host):
            event.add("ip", host)
        else:
            event.add("host", host)
        event.add("source time", date)
        # handle description data
        description = keys.get("description")
        for part in description.split(","):
            pair = part.split(":", 1)
            if len(pair) < 2:
                continue
            key = pair[0].strip()
            value = pair[1].strip()
            if not key or not value:
                continue
            if key == "Host":
                value = "hxxp://" + value
                event.add("url", value)
            if key == "Description":
                event.add(key.lower(), value)
            elif key == "IP address":
                event.add("ip", value)
        event.add("feed", "mdl")
        event.add("type", "malware")
        return event

if __name__ == "__main__":
    MalwareDomainListBot.from_command_line().execute()
