import time

import idiokit
from abusehelper.core import utils, bot, events

def normalized_date(string,
                    in_format="%Y/%m/%d_%H:%M",
                    out_format="%Y-%m-%d %H:%M:%S UTC"):
    try:
        struct = time.strptime(string, in_format)
    except ValueError:
        return None
    return time.strftime(out_format, struct)

class MDLBot(bot.PollingBot):
    def _filter(self, event, badset=frozenset("-")):
        if event.contains("inactive", "1"):
            return

        new = events.Event()
        for key, value in event.items():
            value = value.strip()
            if value and set(value) != badset:
                new.add(key, value)

        new.update("timestamp", new.values("date", normalized_date))
        new.clear("date")

        new.clear("inactive")
        new.add("feed", "malwaredomainlist")

        return (new,)

    @idiokit.stream
    def poll(self, url="http://www.malwaredomainlist.com/mdlcsv.php"):
        self.log.info("Downloading MDL database")
        try:
            info, fileobj = yield utils.fetch_url(url)
        except utils.FetchUrlFailed, fuf:
            self.log.error("MDL database downloading failed: %r", fuf)
            return
        self.log.info("MDL database downloaded")

        columns = ["date", "url", "ip", "reverse", "description",
                   "registrant", "asn", "inactive", "cc"]
        yield (utils.csv_to_events(fileobj, columns=columns)
               | idiokit.map(self._filter))

if __name__ == "__main__":
    MDLBot.from_command_line().execute()
